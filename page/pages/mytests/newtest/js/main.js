const firebaseConfig={apiKey:"AIzaSyCOIQr3REsBR9gTfPNo37uDiruxsLibrM8",authDomain:"testcontent-d38c2.firebaseapp.com",databaseURL:"https://testcontent-d38c2-default-rtdb.firebaseio.com",projectId:"testcontent-d38c2",storageBucket:"testcontent-d38c2.appspot.com",messagingSenderId:"958227719442",appId:"1:958227719442:web:bb8bd9dd4e8fde1a817fcb"};var Data;firebase.initializeApp(firebaseConfig);var username=localStorage.getItem("ss47_webtest_user_i"),_u_n_=localStorage.getItem("ss47_webtest_user_n"),question_id=localStorage.getItem("ss47_webtest_task_i");CheckUser();var tasks=[],Changing=-1,curTask=[],curCheck=-1;function JsonToList(e){var t=e,n=[];for(var a in t)n.push([a,t[a]]);return n}function CheckEditing(){if(""!=question_id){var e=Data.users[username][question_id],t=e.config,n=document.getElementById("id_test_name"),a=document.getElementById("id_test_timing"),r=document.getElementById("id_tests_time"),s=document.getElementById("id_randquestion"),i=document.getElementById("id_randvariant"),o=Decode(t.testname),u=Decode(t.intime),c=Decode(t.time),d=Decode(t.randquestion),l=Decode(t.randvariant);n.value=o,r.value=c,"true"==u&&a.setAttribute("checked",""),"true"==d&&s.setAttribute("checked",""),"true"==l&&i.setAttribute("checked","");var m=JsonToList(e.questions);tasks=[];for(var g=0;g<m.length;g++){var h=-1,_=[],f=m[g][1],v=JsonToList(f.variants);_.push(Decode(f.value));for(var p=0;p<v.length;p++){var k=v[p][1];_.push(Decode(k.value)),"1"==Decode(k.truevar)&&(h=p+1)}_.push(h),tasks.push(_NewArray(_))}UpdateMainQuestionList()}}async function CheckUser(){await firebase.database().ref().get().then(e=>{e.exists()?(Data=e.val(),CheckEditing()):console.log("Server Error!")}).catch(e=>{alert("No Connection!"),console.error(e)})}function _NewArray(e){for(var t=[],n=0;n<e.length;n++)t.push(e[n]);return t}function ToInteger(e){return e.charCodeAt(0)}function ToChar(e){return String.fromCharCode(parseInt(e))}function Encrypt(e){var t="";t+=e;for(var n="",a=0;a<t.length;a++)n+="%"+ToInteger(t[a]);return n}function Decode(e){var t="",n="";e+="%";for(var a=1;a<e.length;a++)"%"==e[a]?(t+=ToChar(n),n=""):n+=e[a];return t}function FixedSpace(e){var t="";if(0==e.length)return"";t+=e[0];for(var n=1;n<e.length;n++)e[n]==e[n-1]&&" "==e[n]?t+="&nbsp":t+=e[n];return t}function Fixed(e){for(var t=FixedSpace(e),n="",a=0;a<t.length;a++)"<"==t[a]?n+="&lt;":">"==t[a]?n+="&gt;":n+=t[a];return n}function IsEmpty(e){for(var t=0;t<e.length;t++)if(" "!=e[t])return!1;return!0}function FixedQID(e){var t="";for(t+=e;t.length<5;)t="0"+t;return t}function FixedJsonStr(e){for(var t="",n=0;n<e.length;n++)"\n"!=e[n]&&" "!=e[n]&&"\t"!=e[n]&&(t+=e[n]);return t}function _FixedQuestionNumber(e){var t="";for(t+=e;t.length<10;)t="0"+t;return t}async function SaveTest(){var e=document.getElementById("id_test_name").value,t=document.getElementById("id_test_timing").checked,n=document.getElementById("id_tests_time").value,a=document.getElementById("id_randquestion").checked,r=document.getElementById("id_randvariant").checked;if(IsEmpty(e))alert("Test Name should not be empty!");else if(t&&""==n)alert("Tests Time not set!");else if(tasks.length<1)alert("Questions number should be at least 1!");else{for(var s=0;s<tasks.length;s++){var i=_NewArray(tasks[s]),o=parseInt(i.length);if(IsEmpty(i[0]))return void alert("Question should not be empty! (Question "+(s+1)+")");if(o<4)return void alert("Variants number should be at least 2! (Question "+(s+1)+")");for(var u=1;u<o-1;u++)if(IsEmpty(i[u]))return void alert("Variant should not be empty! (Question "+(s+1)+", Variant "+u+")");if(-1==parseInt(i[o-1]))return void alert("True variant not set! (Question "+(s+1)+")")}for(var c='{\n\t"config":{\n\t\t"testname":"'+Encrypt(e)+'",\n\t\t"intime":"'+Encrypt(t)+'",\n\t\t"time":"'+Encrypt(n)+'",\n\t\t"randquestion":"'+Encrypt(a)+'",\n\t\t"randvariant":"'+Encrypt(r)+'"\n\t},\n\t"questions":{',d=0;d<tasks.length;d++){var l=1,m=0;l+=d,m+=tasks[d][tasks[d].length-1],c+='"question'+FixedQID(l)+'":{',c+='"value":"'+Encrypt(tasks[d][0])+'",',c+='"variants":{';for(s=1;s<tasks[d].length-1;s++){var g=0;s==m&&(g=1),c+='"variant'+FixedQID(s)+'":{',c+='"truevar":"'+Encrypt(g)+'",\n\t\t\t"value":"'+Encrypt(tasks[d][s])+'"',c+="}",s<tasks[d].length-2&&(c+=",")}c+="}",c+="}",d<tasks.length-1&&(c+=",")}c=FixedJsonStr(c+="}\n\t}"),await firebase.database().ref().get().then(e=>{if(e.exists()){NewData=e.val();var t=parseInt(NewData.users[username].questionnum);NewData.users[username].questionnum=t+1,NewData.users[username]["question"+_FixedQuestionNumber(t)]=JSON.parse(c),firebase.database().ref("users/"+username).set(NewData.users[username]),alert("Saved!\nTest Number: "+(t+1))}else console.log("Server Error!")}).catch(e=>{alert("No Connection!"),console.error(e)})}}function UpdateMainQuestionList(){for(var e="",t=0;t<tasks.length;t++){var n=t+1,a=tasks[t].length-2;e+='<tr>\n      <th scope="row">'+n+"</th>\n      <td>"+Fixed(tasks[t][0])+"</td>\n      <td>"+a+'</td>\n      <td><div class="btn-group"><button class="btn btn-success" data-toggle="modal" data-target="#newQuestion" onclick="OpeningQuestion('+t+')">Изменить</button><button class="btn btn-danger" onclick="RemoveMainQuestion('+t+')">Удалить</button></div></td>\n    </tr>'}document.getElementById("id_question_list").innerHTML=e}function SetNewQuestionsParameters(){var e="";e+='<center>\n            <br>\n            <font style="color: white;">Вопрос</font><br><br>\n              <textarea type="text" id="id_variant_0" onchange="VarChanged(0)" autocomplete="off" required="" style="width:350px;outline:none;background-color:black;color:white;" >'+curTask[0]+"</textarea>\n            <br><br>",e+='<table border="1">';for(var t=1;t<curTask.length;t++){var n="";curCheck==t&&(n+="checked"),e+='\n    \t<div class="input-container">\n              <input type="text" style="width:65%;" id="id_variant_'+t+'" autocomplete="off" required="" onchange="VarChanged('+t+')" value="'+curTask[t]+'" />\n              <label>Вариант '+t+'</label><button class="btn btn-outline-danger" style="margin-left:2px;font-weight:700;" onclick="WantRemove('+t+')">Удалить</button>\n              <div class="custom_radio">\n  <input type="radio" id="id_radio_'+t+'" '+n+' onclick="TrueVarChecked('+t+')"><label for="id_radio_'+t+'">Правильный вариант</label>\n</div>\n            </div>'}e+="</table>",e+='<button class="btn btn-success" onclick="AddNewVariant()">Добавить вариант</button>',document.getElementById("id_new_question_content").innerHTML=e}function OpeningQuestion(e){document.getElementById("id_question_manip_title").innerHTML="Change Task",document.getElementById("id_btn_add_new_question").innerHTML="ИЗМЕНИТЬ",curTask=_NewArray(tasks[parseInt(e)]),curCheck=parseInt(curTask[curTask.length-1]),curTask.splice(curTask.length-1,1),Changing=parseInt(e),SetNewQuestionsParameters()}function RemoveMainQuestion(e){tasks.splice(parseInt(e),1),UpdateMainQuestionList()}function AddNewVariant(){curTask.push(""),SetNewQuestionsParameters()}function TrueVarChecked(e){curCheck=parseInt(e),SetNewQuestionsParameters()}function VarChanged(e){curTask[parseInt(e)]=document.getElementById("id_variant_"+e).value}function WantRemove(e){curTask.splice(parseInt(e),1),parseInt(e)==curCheck?curCheck=-1:parseInt(e)<curCheck&&curCheck--,SetNewQuestionsParameters()}document.getElementById("id_btn_back").onclick=function(){localStorage.setItem("ss47_webtest_user_i",username),localStorage.setItem("ss47_webtest_user_n",_u_n_),window.location="../mytests.html"},document.getElementById("id_btn_add_question").onclick=function(){document.getElementById("id_question_manip_title").innerHTML="New Task",document.getElementById("id_btn_add_new_question").innerHTML="ДОБАВИТЬ",curTask=[""],curCheck=-1,Changing=-1,SetNewQuestionsParameters()},document.getElementById("id_btn_add_new_question").onclick=function(){-1==Changing?(curTask.push(curCheck),tasks.push(curTask),UpdateMainQuestionList()):(curTask.push(curCheck),tasks[Changing]=_NewArray(curTask),Changing=-1,UpdateMainQuestionList())},document.getElementById("id_btn_save").onclick=function(){SaveTest()};
